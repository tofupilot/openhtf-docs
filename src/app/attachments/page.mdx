export const metadata = {
  title: 'Test Attachments | OpenHTF',
  description:
    'Learn how to capture and attach various types of data files, such as CSV and image files, to your OpenHTF test records for comprehensive hardware testing.',
}

# Attachments

Hardware testing often involves capturing data such as pictures or measurement files. OpenHTF makes it easy to link these files to the test records using its attachment features. {{ className: 'lead' }}

## Usage

To add attachments in your OpenHTF script, you can use the `test.attach` method. Below are examples of adding different types of attachments to your script and sample output files.

### Creating and Attaching Content Directly

You can create and attach content directly to the test record using the `test.attach` function.

```python {{ title: 'main.py' }}
import os
from openhtf import test, PhaseResult

@test.PhaseOptions()
def my_test_phase(test):
    test.attach('test_attachment', 'This is test attachment data.'.encode('utf-8'))
    return PhaseResult.CONTINUE

if __name__ == "__main__":
    test = openhtf.Test(my_test_phase)
    test.execute()
```

### Attaching a Pre-existing File

You can also attach an existing file to the test output using the `test.attach_from_file` function.

````python {{ title: 'main.py' }}
import os
from openhtf import test, PhaseResult

@test.PhaseOptions()
def my_test_phase(test):
    # Create a sample file to attach
    with open('example_attachment.txt', 'w') as f:
        f.write('This is example attachment content.')

    # Attach the file to the test record
    test.attach_from_file(os.path.join(os.path.dirname(__file__), 'example_attachment.txt'))
    return PhaseResult.CONTINUE

if __name__ == "__main__":
    test = openhtf.Test(my_test_phase)
    test.execute()
    ```

### Loading Attached Files
To load and access attached files during test execution, use the `test.get_attachment` function.

```python {{ title: 'main.py' }}
import os
from openhtf import test, PhaseResult

@test.PhaseOptions()
def attach_phase(test):
    test.attach('test_attachment', 'This is test attachment data.'.encode('utf-8'))
    return PhaseResult.CONTINUE

@test.PhaseOptions()
def load_attachment_phase(test):
    test_attachment = test.get_attachment('test_attachment')
    print(test_attachment)
    return PhaseResult.CONTINUE

if __name__ == "__main__":
    test = openhtf.Test(attach_phase, load_attachment_phase)
    test.execute()
    ```

## Example 1: CSV File

In this example, we generate a CSV file containing measurement data and attach it to the test output.

```python {{ title: 'main.py' }}
import openhtf as htf
from openhtf.output.callbacks import json_factory

@htf.measures(htf.Measurement('voltage'), htf.Measurement('current'))
def electrical_measurements(test):
    voltage = 12.0  # Volts
    current = 1.5  # Amperes
    test.measurements.voltage = voltage
    test.measurements.current = current

    # Create and attach CSV content
    csv_content = 'Voltage,Current\n{},{}'.format(voltage, current)
    test.attach('measurement_data_csv', csv_content.encode('utf-8'), mimetype='text/csv')

@htf.measures()
def load_attachment_phase(test):
    attachment = test.get_attachment('measurement_data_csv')
    if attachment:
        attachment_content = attachment.data.decode('utf-8')  # Assuming CSV content is UTF-8 encoded
        print(attachment_content)
        test.logger.info('Loaded and printed the attachment content:\n%s', attachment_content)
    else:
        test.logger.error('Attachment not found.')

def main():
    test = htf.Test(electrical_measurements, load_attachment_phase)
    test.add_output_callbacks(json_factory.OutputToJSON('test_results.json', indent=2))
    test.execute(test_start=lambda: 'DeviceUnderTest123')

if __name__ == '__main__':
    main()
````

In this example, the CSV file is added directly to the test output file:

```javascript {{ title: 'test_results.json' }}
{
  "dut_id": "DeviceUnderTest123",
    ...
  "phases": [
    ...
    {
     ...
      "attachments": {
        "measurement_data_csv": {
          "mimetype": "text/csv",
          "sha1": "c85da4ff90e4feb5f7b4ca02a61cc193170dbfaa",
          "data": "Vm9sdGFnZSxDdXJyZW50CjEyLjAsMS41"
        }
      },
    }
  ]
}
```

## Example 2: Image File

In this example, we generate a PNG image of a curve using a library like Matplotlib and attach it to the test record as a pre-existing file.

```sh
pip install matplotlib
```

```python
import openhtf as htf
import logging
import os
import numpy as np
import matplotlib.pyplot as plt
from openhtf.output.callbacks import json_factory

# Use a non-interactive backend for Matplotlib
plt.switch_backend('Agg')

@htf.measures(
    htf.Measurement('temperature').with_units('C').in_range(20, 30)
)
def temperature_measurement(test):
    test.logger.info('Starting temperature measurement phase.')
    temperature = 25  # Initial temperature in Celsius
    test.measurements.temperature = temperature

    # Create a folder for output files
    os.makedirs('output_files', exist_ok=True)

    # Generate a realistic temperature curve within limits
    time = np.linspace(0, 10, 100)
    temperature_curve = temperature + 3 * np.sin(time) + np.random.normal(0, 0.5, size=time.shape)
    temperature_curve = np.clip(temperature_curve, 20, 30)  # Ensure values stay within limits

    # Plot the temperature curve
    plt.figure()
    plt.plot(time, temperature_curve, label='Temperature')
    plt.axhline(y=30, color='r', linestyle='--', label='Upper Limit')
    plt.axhline(y=20, color='r', linestyle='--', label='Lower Limit')
    plt.title('Temperature Measurement Over Time')
    plt.xlabel('Time (s)')
    plt.ylabel('Temperature (C)')
    plt.legend()
    plt.ylim(15, 35)  # Add some margin around the limits
    image_file_path = 'output_files/temperature_curve.png'
    plt.savefig(image_file_path)
    plt.close()

    # Attach the image file
    with open(image_file_path, 'rb') as f:
        test.attach('temperature_curve_image', f.read(), mimetype='image/png')

    test.logger.info('Completed temperature measurement phase.')

def main():
    logging.basicConfig(level=logging.INFO)
    test = htf.Test(temperature_measurement)
    test.add_output_callbacks(
        json_factory.OutputToJSON('./output_files/test_results.json', indent=2)
    )
    test.execute(test_start=lambda: 'DeviceUnderTest456')

if __name__ == '__main__':
    main()
```

Test log and attachments are stored next to each other in the output directory:

```txt
output_files/
├── temperature_curve.png
└── test_results.json
```

The generated image looks like this:

<Image
  srcLight="/temperature_curve.png"
  srcDark="/temperature_curve.png"
  alt="Attachement example"
/>

The JSON log also includes a binary version of the image:

```javascript {{ title: 'test_results.json' }}
"attachments": {
    "temperature_curve_image": {
      "mimetype": "image/png",
      "sha1": "90ab4aa2f71b52b0492e31be3430cc53581cd5d6",
      "data": "iVBORw0KGgoAAAANSUhEUgAAAoAAAAHgCAYAAAA10dzkAAA..."
    }
}
```
