
# OpenHTF Guidelines

## Phase granularity

We recommend performing a single read or write operation on the unit under test (uut) per phase. 

## Decorators syntax
You can have two different syntaxes. Technically, these syntaxes can be mixed, but as a matter of convention you should always use one or the other within a single decorator call. 
We will use the syntaxe in the script below for all the examples.

``` python {{title: 'main.py'}}
import openhtf as htf
from openhtf.output.callbacks import json_factory


@htf.measures(
    htf.Measurement("first_measurement"),
    htf.Measurement("second_measurement"),
    htf.Measurement("third"),
    htf.Measurement("fourth"),
)
def example_phase(test):
    test.measurements.first_measurement = "First!"
    test.measurements.second_measurement = "Second!"

    for measurement in ("third", "fourth"):
        test.measurements[measurement] = measurement + " is the best!"

    return htf.PhaseResult.CONTINUE


def main():
    test = htf.Test(example_phase)
    test.add_output_callbacks(json_factory.OutputToJSON("test_result.json", indent=2))
    test.execute(lambda: "PCB001")


if __name__ == "__main__":
    main()
```

## Import openhtf

In this documentation we will rely on the examples provided in the main repository. The `openhtf` syntax will be the same in all examples.

``` python
import openhtf as htf
```


## Example 1: CSV File

In this example, we generate a CSV file containing measurement data and attach it to the test output.

```python {{ title: 'main.py' }}
import openhtf as htf
import logging
import os
from openhtf.output.callbacks import json_factory

@htf.measures(htf.Measurement("voltage"), htf.Measurement("current"))
def electrical_measurements(test):
    # Simulated electrical measurements
    voltage = 12.0  # Volts
    current = 1.5  # Amperes
    test.measurements.voltage = voltage
    test.measurements.current = current

    # Create the output directory if it doesn't exist
    os.makedirs("output_files", exist_ok=True)

    # Save the data to a CSV file
    csv_file_path = "output_files/measurement_data.csv"
    with open(csv_file_path, "w") as csv_file:
        csv_file.write("Voltage,Current\n")
        csv_file.write(f"{voltage},{current}\n")

    # Attach the CSV file to the test
    with open(csv_file_path, "rb") as f:
        test.attach("measurement_data_csv", f.read(), mimetype="text/csv")

def load_attachment_phase(test):
    # Load and print the attached CSV content
    attachment = test.get_attachment("measurement_data_csv")
    if attachment:
        attachment_content = attachment.data.decode("utf-8")
        print(attachment_content)
        test.logger.info(
            "Loaded and printed the attachment content:\n%s", attachment_content
        )
    else:
        test.logger.error("Attachment not found.")

def main():
    logging.basicConfig(level=logging.INFO)
    test = htf.Test(electrical_measurements, load_attachment_phase)
    test.add_output_callbacks(
        json_factory.OutputToJSON("output_files/test_results.json", indent=2)
    )
    test.execute(test_start=lambda: "DeviceUnderTest123")

if __name__ == "__main__":
    main()
```

Test log and attachments are stored next to each other in the output_files directory:

```txt
output_files/
├── measurement_data.csv
└── test_results.json
```

And the CSV file is added directly to the test output file:

```javascript {{ title: 'test_results.json' }}
{
  "dut_id": "DeviceUnderTest123",
    ...
  "phases": [
    ...
    {
     ...
      "attachments": {
        "measurement_data_csv": {
          "mimetype": "text/csv",
          "sha1": "c85da4ff90e4feb5f7b4ca02a61cc193170dbfaa",
          "data": "Vm9sdGFnZSxDdXJyZW50CjEyLjAsMS41"
        }
      },
    }
  ]
}
```

## Example 2: Image

In this example, we generate a PNG image of a curve using a library like Matplotlib and attach it to the test record as a pre-existing file.

```sh
pip install matplotlib
```

```python {{ title: 'main.py' }}
import openhtf as htf
import logging
import os
import numpy as np
import matplotlib.pyplot as plt
from openhtf.output.callbacks import json_factory

# Use a non-interactive backend for Matplotlib
plt.switch_backend('Agg')

@htf.measures(
    htf.Measurement('temperature').with_units('C').in_range(20, 30)
)
def temperature_measurement(test):
    test.logger.info('Starting temperature measurement phase.')
    temperature = 25  # Initial temperature in Celsius
    test.measurements.temperature = temperature

    # Create a folder for output files
    os.makedirs('output_files', exist_ok=True)

    # Generate a realistic temperature curve within limits
    time = np.linspace(0, 10, 100)
    temperature_curve = temperature + 3 * np.sin(time) + np.random.normal(0, 0.5, size=time.shape)
    temperature_curve = np.clip(temperature_curve, 20, 30)  # Ensure values stay within limits

    # Plot the temperature curve
    plt.figure()
    plt.plot(time, temperature_curve, label='Temperature')
    plt.axhline(y=30, color='r', linestyle='--', label='Upper Limit')
    plt.axhline(y=20, color='r', linestyle='--', label='Lower Limit')
    plt.title('Temperature Measurement Over Time')
    plt.xlabel('Time (s)')
    plt.ylabel('Temperature (C)')
    plt.legend()
    plt.ylim(15, 35)  # Add some margin around the limits
    image_file_path = 'output_files/temperature_curve.png'
    plt.savefig(image_file_path)
    plt.close()

    # Attach the image file
    with open(image_file_path, 'rb') as f:
        test.attach('temperature_curve_image', f.read(), mimetype='image/png')

    test.logger.info('Completed temperature measurement phase.')

def main():
    logging.basicConfig(level=logging.INFO)
    test = htf.Test(temperature_measurement)
    test.add_output_callbacks(
        json_factory.OutputToJSON('./output_files/test_results.json', indent=2)
    )
    test.execute(test_start=lambda: 'DeviceUnderTest456')

if __name__ == '__main__':
    main()
```

Test log and attachments are stored next to each other in the output directory:

```txt
output_files/
├── temperature_curve.png
└── test_results.json
```

The generated image looks like this:

<Image
  srcLight="/temperature_curve.png"
  srcDark="/temperature_curve.png"
  alt="Attachement example"
/>

The JSON log also includes a binary version of the image:

```javascript {{ title: 'test_results.json' }}
"attachments": {
    "temperature_curve_image": {
      "mimetype": "image/png",
      "sha1": "90ab4aa2f71b52b0492e31be3430cc53581cd5d6",
      "data": "iVBORw0KGgoAAAANSUhEUgAAAoAAAAHgCAYAAAA10dzkAAA..."
    }
}
```

---