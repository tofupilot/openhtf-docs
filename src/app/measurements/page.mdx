export const metadata = {
  title: 'Measurements',
  description:
    'Learn how to capture and validate data within OpenHTF phases, including simple, multiple, validated, inline, multidimensional, and marginal measurements, with detailed examples and code snippets.',
}

# Measurements

Create measurements to capture and validate data within phases. {{ className: 'lead' }}

<Image
  src="/measurements-header.png"
  alt="OpenHTF Device Under Test (DUT) documentation section header with TofuPilot."
/>

## Overview

You can use measurements to capture and validate values during a test. 
These values can be [numeric](#numeric), [boolean](#boolean), or [string](#string), and may be either simple or [multidimensional](#multidimensional). 
Use the built-in validations in the decorator: you can define measurements with predefined units, types and validation rules.

Measurements are attached to Test Phases using `@openhtf.measures()` decorator.


<Note>
  Measurements should not be used for large data, such as binary files, which
  should be stored as [attachments](/attachments).
</Note>

## Numeric

By using numeric measurements, you can test values against a defined range or specific validation criteria. 

```python {{ title: 'main.py' }}
import openhtf as htf
from openhtf.util import units


@htf.measures(
    htf.Measurement("temperature")     # Declares a measurement 'temperature'
    .in_range(0, 100)                  # Define limits between 0 and 100
    .with_units(units.DEGREE_CELSIUS)  # Specifies the unit as Celsius
    .with_precision(1)                 # Rounds to 1 decimal place
)
def temperature_phase(test):
    test.measurements.temperature = 25 # Set the temperature value to 25°C


def main():
    test = htf.Test(temperature_phase)
    test.execute(lambda: "SI051AB7B0001")


if __name__ == "__main__":
    main()
```

### Validator decorators

Validators are a list of callable objects to perform pass/fail checks.
You can parameter them in the decorator to provide unit, type, and validation infromation. 

<Properties>
  <Property name=".in_range(minimum, maximum)" type="Number">
    Ensures the value is within the given range.
  </Property>
  <Property name=".with_units(units)" type="opehtf.util.units (default=None)">
    Adds units to the measurement (e.g., Celsius, Volts).   
  </Property>
  <Property name=".with_precision(precision)" type="int default=None">
    Rounds the value to the specified precision before validation.
  </Property>
</Properties>

### Options

<Properties>
   <Property name="name" type="string">
    Configure name of the measurement.
  </Property>
  <Property name="units" type="openhtf.util.units (default=None)">
    Adds units to the measurement (e.g., Celsius, Volts). 
  </Property>
  <Property name="docstring" type="string (Optional)">
    Applies a transformation function to modify the value before validation.
  </Property>
  <Property name="marginal" type="bool ()">
    Indicate if this measurement is marginal if the outcome is `PASS`.
  </Property>
  <Property name=".with_transform(fn)">
    Applies a transformation function to modify the value before validation.
  </Property>
</Properties>

## Boolean

Boolean measurements represent pass/fail, true/false type data, commonly used to check test conditions.

### Syntax

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('is_device_connected')  # Declares a boolean measurement
    .equals(True)  # Ensures the value is exactly True
)
def is_device_connected_phase(test):
    test.measurements.is_device_connected = True  # Sets the boolean value to True

def main():
    test = htf.Test(is_device_connected_phase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == '__main__':
    main()
```

### Validators

<Properties>
  <Property name=".equals(value)">
    Ensures the measurement exactly matches the specified boolean value.
  </Property>
  <Property name=".in_set({value1, value2})">
    Ensures the string is one of the predefined valid values.
  </Property>
</Properties>

### Options

<Properties>
  <Property name=".with_units(unit)">
    Adds units to the measurement (e.g., Celsius, Volts).
  </Property>
  <Property name=".with_transform(fn)">
    Applies a transformation function to modify the value before validation.
  </Property>
</Properties>

## String

String measurements store text or labels, which are validated for exact matches or based on predefined sets of valid values.

### Example

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('device_status')  # Declares a string measurement 'device_status'
    .equals('OK')  # Ensures the value is exactly 'OK'
)
def StatusCheckPhase(test):
    test.measurements.device_status = 'OK'  # Set the status value to 'OK'

def main():
    test = htf.Test(StatusCheckPhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == '__main__':
    main()
```

### Validators

<Properties>
  <Property name=".equals(value)">
    Ensures the string matches the expected value.
  </Property>
  <Property name=".in_set({value1, value2})">
    Ensures the string is one of the predefined valid values.
  </Property>
</Properties>

## Multidimensional

Multidimensional measurements allow for capturing data that spans multiple coordinates, such as time-series data or data across multiple levels or categories.

### Example

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('voltage_over_time')  # Declares a multidimensional measurement
    .with_dimensions('time', 'voltage')  # Specifies the dimensions: time and voltage
)
def VoltagePhase(test):
    test.measurements.voltage_over_time[0] = 3.3  # At time 0, voltage is 3.3V
    test.measurements.voltage_over_time[1] = 3.5  # At time 1, voltage is 3.5V

def main():
    test = htf.Test(VoltagePhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == '__main__':
    main()
```

### Validators

<Properties>
  <Property name=".in_range(min_value, max_value)">
    Can be applied to each value in the multidimensional set.{' '}
  </Property>
</Properties>

### Options

<Properties>
  <Property name=".with_dimensions(*dims)">
    Adds multiple units for multidimensional measurements (e.g., time,
    frequency).
  </Property>
</Properties>

## Multiple

You can use multiple measurements in a single test phase to capture different types of data at once. This is helpful when a test involves monitoring several aspects (e.g., temperature, pressure, and voltage) simultaneously.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('temperature')  # Temperature measurement
    .in_range(0, 100)  # Ensure the temperature is between 0 and 100°C
    .with_units('C'),  # Specify Celsius as the unit
    measurements.Measurement('pressure')  # Pressure measurement
    .in_range(950, 1050)  # Ensure the pressure is between 950 and 1050 hPa
    .with_units('hPa'),  # Specify hectopascals as the unit
    measurements.Measurement('voltage')  # Voltage measurement
    .in_range(0, 5)  # Ensure the voltage is between 0 and 5V
    .with_units('V')  # Specify volts as the unit
)
def EnvTestPhase(test):
    test.measurements.temperature = 22.5  # Set temperature to 22.5°C
    test.measurements.pressure = 1013  # Set pressure to 1013 hPa
    test.measurements.voltage = 3.3  # Set voltage to 3.3V

def main():
    test = htf.Test(EnvTestPhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```

## TofuPilot integration

vous pouvez analyser les mesures faites par les diférntes de vos tests sur tofupilot sans cahnegemnt dans votre test car tofupilot support nativement les phases et measures d'openhtf

après avoir installé le client tofupilot et ajouter la callback d'upload dans votre script

exemple

vous verrez les mesures dans la page de chaque run

<Image
  src="/measurements-header.png"
  alt="OpenHTF Device Under Test (DUT) documentation section header with TofuPilot."
/>

en cliquant sur n'importe quelle measure vous pouvez voir ses comparer les résultats avec tous les runs

<Image
  srcLight="/measurements-header.png"
  srcDark="/measurements-header.png"
  alt="OpenHTF Device Under Test (DUT) documentation section header with TofuPilot."
/>

---

## Advanced use cases

You can leverage advanced OpenHTF options to handle complex measurement use cases.

### Documentation

You can add a description to your measurements.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('temperature').in_range(0, 100).with_units('C')
    .doc('This measurement tracks the ambient temperature during the test.')
)
def TemperaturePhase(test):
    test.measurements.temperature = 25

def main():
    test = htf.Test(TemperaturePhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```

### Argument Substitution

You can add a description to your measurements.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('test_result_{level}').with_args(level='high').equals('PASS')
)
def TestPhase(test):
    test.measurements.test_result_high = 'PASS'

def main():
    test = htf.Test(TemperaturePhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```

### Notification Callback

You can set a callback to trigger when a measurement is set.

```python {{ title: 'main.py' }}
import openhtf as htf

def my_callback():
    print("Measurement set!")

@htf.measures(
    measurements.Measurement('temperature').in_range(0, 100).with_units('C')
    .set_notification_callback(my_callback)
)
def TemperaturePhase(test):
    test.measurements.temperature = 25

def main():
    test = htf.Test(TemperaturePhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```

### Marginal Measurements

You can mark a measurement as marginal, indicating that while it passes validation, it is near the boundary of failure.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('power_output').in_range(0, 100)
    .validate_on({'PASS': lambda x: x > 50})
)
def PowerTestPhase(test):
    test.measurements.power_output = 75

def main():
    test = htf.Test(PowerTestPhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```

For finer granularity in test results, use marginal measurements. They set stricter limits within the acceptable range, giving detailed information about test performance. **This allows distinguishing between fully passing results and those close to failing, without affecting the overall phase outcome**, helping identify potential issues early.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    htf.Measurement('resistance').with_units('ohm').in_range(
        minimum=5, maximum=17, marginal_minimum=9, marginal_maximum=11))
def measure_resistance(test):
    test.measurements.resistance = 13  # Ohms

def main():
    test = htf.Test(measure_resistance)
    test.execute(lambda: "DeviceUnderTest123")

if __name__ == '__main__':
    main()
```

### Conditional Validation

You can apply conditional validation based on outcomes.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('power_output').in_range(0, 100)
    .validate_on({'PASS': lambda x: x > 50})
)
def PowerTestPhase(test):
    test.measurements.power_output = 75

def main():
    test = htf.Test(PowerTestPhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```

### Transformation Function

You can modify measurement values before validation.

```python {{ title: 'main.py' }}
import openhtf as htf

@htf.measures(
    measurements.Measurement('voltage').in_range(0, 10)
    .with_transform(lambda x: x * 1.1).with_units('V')
)
def VoltagePhase(test):
    test.measurements.voltage = 5

def main():
    test = htf.Test(VoltagePhase)
    test.execute(lambda: "SI051AB7B0001")

if __name__ == "__main__":
    main()
```
