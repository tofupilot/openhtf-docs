export const metadata = {
  title: 'Phases',
  description:
    'Discover how to define and execute test phases using OpenHTF. This guide covers phase creation, phase results, and phase options with detailed examples and code snippets.',
}

# Phases

You can organize your test flow by breaking it down into multiple phases. {{ className: 'lead' }}

<Image
  src="/phases-header.png"
  alt="OpenHTF Device Under Test (DUT) documentation section header with TofuPilot."
/>

## Overview

In OpenHTF, you can use phases to handle specific test tasks like measurements, device control, and data processing. Each phase tracks its status and duration, showing whether it passed or failed and how long it took.

When combined with anayltics platform like TofuPilot, phases help you clearly identify the cause of errors, and determine what is making the test take longer.

## Definition

Phases are standard Python functions that take the `test` object as an input argument and return a `PhaseResult`. To execute them, you must add them to the test definition:

```python {{ title: 'main.py' }}
import openhtf as htf

def first_phase(test):
    return htf.PhaseResult.CONTINUE

def second_phase(test):
    return htf.PhaseResult.CONTINUE

def third_phase(test):
    return htf.PhaseResult.CONTINUE

if __name__ == '__main__':
    test = htf.Test(first_phase, second_phase, third_phase)
    test.execute(lambda: "SI051AB7B0001")
```

The console returns:

```txt
======================= test: openhtf_test  outcome: PASS ======================
```

## Results

You can use the following `PhaseResult`:

<Properties>
  <Property name="PhaseResult.CONTINUE">
    Mark the phase as **Pass** and execute the next phase.
  </Property>
  <Property name="PhaseResult.STOP">
    Mark the phase as **Fail** and stop executing the test.
  </Property>
  <Property name="PhaseResult.REPEAT">Execute the same phase again.</Property>
  <Property name="PhaseResult.FAIL_AND_CONTINUE">
    Mark phase as **Fail** and execute the next phase.
  </Property>
  <Property name="PhaseResult.SKIP">
    Ignore the current phase and execute the next phase.
  </Property>
</Properties>

Specific `PhaseResult` can be returned by test phases to indicate the next action after phase execution.

```python {{ title: 'main.py' }}
import openhtf as htf
import random

# Always pass
def pass_phase(test):
    return htf.PhaseResult.CONTINUE

# Retries on failure
def retry_phase(test):
    if random.choice([True, False]):
        return htf.PhaseResult.CONTINUE
    else:
        return htf.PhaseResult.REPEAT

# Fail and stop the test
def fail_phase(test):
    return htf.PhaseResult.STOP

if __name__ == '__main__':
    test = htf.Test(pass_phase, retry_phase, fail_phase)
    test.execute(lambda: "SI051AB7B0001")
```

The console returns:

```txt
======================= test: openhtf_test  outcome: FAIL ======================
```

## Options

You can use the `@htf.PhaseOptions` decorator to override the default behaviors:

<Properties>
  <Property name="name" type="string">
    Override for the name of the phase.
  </Property>
  <Property name="timeout_s" type="float">
    Timeout for the phase, in seconds.
  </Property>
  <Property name="run_if" type="callable">
    Callback to decide whether to run the phase.
  </Property>
  <Property name="repeat_on_measurement_fail" type="bool">
    Repeat phase on measurement failure.
  </Property>
  <Property name="repeat_on_timeout" type="bool">
    Repeat phase on timeout.
  </Property>
  <Property name="repeat_limit" type="int or None">
    Maximum number of repeats, None for infinite.
  </Property>
  <Property name="force_repeat" type="bool">
    Force the phase to repeat up to repeat_limit times.
  </Property>
  <Property name="requires_state" type="bool">
    Pass the whole TestState if True, otherwise pass TestApi.
  </Property>
  <Property name="run_under_pdb" type="bool">
    Run the phase under the Python Debugger.
  </Property>
  <Property name="phase_name_case" type="enum">
    Case formatting options for phase name.
  </Property>
  <Property name="stop_on_measurement_fail" type="bool">
    Stop the test if any measurements fail.
  </Property>
</Properties>

For example:

```python {{ title: 'main.py' }}
import openhtf as htf
from openhtf import PhaseOptions, PhaseResult
import random

# Custom name and timeout
@htf.PhaseOptions(name='Always Pass Phase', timeout_s=5)
def pass_phase(test):
    return PhaseResult.CONTINUE

# Retries on failure with a maximum repeat limit
@htf.PhaseOptions(repeat_limit=3)
def retry_phase(test):
    if random.choice([True, False]):
        return PhaseResult.CONTINUE
    else:
        return PhaseResult.REPEAT

# Will always fail, but only runs if a condition is met
@htf.PhaseOptions(run_if=lambda: random.choice([True, False]))
def conditional_fail_phase(test):
    return PhaseResult.STOP

if __name__ == '__main__':
    test = htf.Test(pass_phase, retry_phase, conditional_fail_phase)
    test.execute(lambda: "SI051AB7B0001")
```

---

## TofuPilot integration
